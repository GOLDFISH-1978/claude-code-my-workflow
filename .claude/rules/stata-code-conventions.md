---
globs: ["projects/*/code/stata/**/*.do", "projects/*/code/main.do"]
---

# Stata Do-File Conventions

**Path scope:** `projects/*/code/stata/**/*.do` and `projects/*/code/main.do`

---

## Hard Rules (No Exceptions)

### 1. Every do-file must write a log
```stata
cap log close
log using "${root}/output/logs/filename_${date}.log", replace text
```
- Open at the top (after globals), close at the bottom
- Use `${date}` macro (`local date = string(today(), "%tdCCYYNNDD")`) for datestamped logs
- If the do-file is called by `main.do`, include the filename in the log path

### 2. All tables and figures must be generated by code
- **Never manually edit `.tex` tables or `.pdf`/`.png` figures after they are produced by code**
- Tables: use `esttab`, `outreg2`, `putexcel`, or `coefplot` → save to `${root}/output/tables/`
- Figures: use `graph export`, `coefplot`, or Stata's `grc1leg` → save to `${root}/output/figures/`
- If you need to adjust a table layout, change the `esttab` call or a do-file, not the output file

---

## Header Block (Required on Every Do-File)

```stata
/*
 * File:        01_clean.do
 * Project:     [PaperSlug]
 * Author:      [Name]
 * Date:        [YYYY-MM-DD]
 * Last edit:   [YYYY-MM-DD]
 *
 * Inputs:      ${root}/data/raw/source_file.dta
 * Outputs:     ${root}/data/processed/clean_sample.dta
 *              ${root}/output/logs/01_clean_YYYYMMDD.log
 *
 * Description: [One sentence describing what this file does]
 */
```

---

## Globals and Paths

Define `${root}` once at the top of `main.do`. All other do-files use it.

```stata
* main.do
global root "/path/to/projects/PaperSlug"   // Set once; no trailing slash
```

- **Never use absolute paths inside analysis do-files**
- Downstream do-files reference `${root}` only; they must work on any machine where `main.do` has been run first

---

## Reproducibility Setup

Add at the top of every do-file that uses random numbers or samples:

```stata
set more off
set seed 12345          // Only in do-files that use random draws
version 17              // Pin Stata version (use your actual version)
```

---

## Merge Discipline

After every merge, verify it succeeded before proceeding:

```stata
merge 1:1 bank_id year using "${root}/data/processed/balance_sheet.dta"
assert _merge != 1      // No unmatched observations from master (or explain why)
count if _merge == 2    // Log how many non-matches from using
drop if _merge == 2     // (Only if expected; document the decision)
drop _merge
```

Always use `count if _merge != 3` before any `drop` after merge. If non-3 merges are expected, document why in a comment.

---

## Regression Output

Use `esttab` (from `estout` package) for all regression tables:

```stata
eststo clear
eststo m1: reghdfe y x1 x2, absorb(bank_id year) vce(cluster bank_id)
eststo m2: reghdfe y x1 x2 x3, absorb(bank_id year) vce(cluster bank_id)

esttab m1 m2 using "${root}/output/tables/table2.tex", ///
    replace booktabs label ///
    b(3) se(3) star(* 0.10 ** 0.05 *** 0.01) ///
    stats(N r2, fmt(%9.0fc %9.3f) labels("Observations" "R-squared")) ///
    title("Table 2: Main Results") ///
    nomtitles nonotes
```

---

## Master Runner (`main.do`)

`main.do` must be the single entry point for the full pipeline:

```stata
* main.do — Master runner for [PaperSlug]
global root "[set this once]"
local date = string(today(), "%tdCCYYNNDD")

cap log close
log using "${root}/output/logs/main_`date'.log", replace text

* 1. Data cleaning
do "${root}/code/stata/01_clean.do"

* 2. Sample construction and merge
do "${root}/code/stata/02_merge.do"

* 3. Main analysis
do "${root}/code/stata/03_analysis.do"

* 4. Robustness checks
do "${root}/code/stata/04_robustness.do"

log close
```

The pipeline must run cleanly from `do main.do` on a fresh Stata session with no prior globals.

---

## Code Quality Checklist

Before marking a do-file complete:

- [ ] Header block present (file, inputs, outputs, description)
- [ ] `log using` at top; `log close` at bottom
- [ ] `global root` not hardcoded in analysis do-files
- [ ] Every `merge` has an `assert` check
- [ ] All tables saved to `output/tables/` via `esttab`/`outreg2`
- [ ] All figures saved to `output/figures/` via `graph export`
- [ ] No manually edited `.tex` or `.pdf` outputs
- [ ] `set seed` present if any random draws occur
- [ ] Runnable from `do main.do` with no prior state
